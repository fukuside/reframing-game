<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="icon" type="image/png" href="/reframing-game/images/icons/icon-192x192.png">
  <link rel="shortcut icon" href="/reframing-game/images/icons/icon-192x192.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ë®ÄËëâ„ÅÆ„É™„Éï„É¨„Éº„Éü„É≥„Ç∞„Ç≤„Éº„É†</title>
    
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SX62V2ND76"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SX62V2ND76');
</script>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="manifest" href="/reframing-game/manifest.json" />

    <!-- iOS -->
  <link rel="apple-touch-icon" sizes="192x192" href="/reframing-game/images/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="512x512" href="/reframing-game/images/icons/icon-512x512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Reframing Game" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Orbitron:wght@700&family=MedievalSharp&display=swap" rel="stylesheet" />

  <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #fdf6e3;
            color: #586e75;
            overflow: hidden;
        }
        .page {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        #login-page, #top-page {
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("data:image/svg+xml,%3csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg' style='image-rendering: pixelated;'%3e%3crect fill='%2377b5fe' x='0' y='0' width='100' height='60'/%3e%3crect fill='%23fecb2e' x='10' y='10' width='20' height='20'/%3e%3crect fill='%2342a5f5' x='0' y='60' width='100' height='40'/%3e%3crect fill='%2320663f' x='5' y='50' width='15' height='10'/%3e%3crect fill='%232E8B57' x='25' y='45' width='20' height='15'/%3e%3crect fill='%2320663f' x='50' y='48' width='10' height='12'/%3e%3crect fill='%232E8B57' x='65' y='42' width='15' height='18'/%3e%3crect fill='%2320663f' x='85' y='52' width='10' height='8'/%3e%3c/svg%3e");
            background-size: cover;
            background-position: center;
            text-align: center;
        }
        #hero-svg {
            width: 150px;
            height: auto;
            margin-bottom: 2rem;
            animation: hero-bob 2s ease-in-out infinite;
        }
        @keyframes hero-bob {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
            100% {
                transform: translateY(0);
            }
        }
        #top-page h1, #login-page h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 3.5rem;
            color: #fdf6e3;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: relative;
            perspective: 800px;
        }
        #word-container {
            position: absolute;
            top: 25%;
            width: 100%;
            height: 100px;
            perspective: 500px;
        }
        #word {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: #dc322f;
            text-shadow: 0 0 8px rgba(220, 50, 47, 0.5);
            transform-style: preserve-3d;
            animation: come-closer 20s linear forwards;
        }
        @keyframes come-closer {
            from {
                transform: translateZ(-2000px) scale(1.1);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            to {
                transform: translateZ(100px) scale(1.2);
                opacity: 1;
            }
        }
        .paused-animation {
            animation-play-state: paused !important;
        }
        #ui-container {
            position: absolute;
            bottom: 10%;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .stats {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #268bd2;
            text-shadow: none;
        }
        #answer-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 0.75rem;
        }
        #input-wrapper {
             display: flex;
             width: 100%;
             gap: 0.5rem;
        }
        #answer-input, #username-input {
            background-color: #eee8d5;
            border: 1px solid #93a1a1;
            color: #073642;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
        }
        #answer-input::placeholder, #username-input::placeholder {
            color: #93a1a1;
        }
        .btn {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            border: none;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #2aa198;
            color: #fdf6e3;
        }
        .btn-secondary {
            background-color: #cb4b16;
            color: #fdf6e3;
        }
        .btn-tertiary {
            background-color: #6c71c4;
            color: #fdf6e3;
        }
        .btn-quest {
            background-color: #855d3c;
            color: #fdf6e3;
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            padding: 1rem 2rem;
            border: 2px solid #654321;
            box-shadow: 0 4px 0 #654321;
        }
        .btn-quest:hover:not(:disabled) {
            background-color: #a07b56;
            box-shadow: 0 2px 0 #654321;
        }
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #modal-content {
            background: #fdf6e3;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #2aa198;
            box-shadow: 0 0 20px rgba(42, 161, 152, 0.4);
        }
        #feedback-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 20;
        }
        .correct {
            color: #859900;
            text-shadow: 0 0 10px rgba(133, 153, 0, 0.5);
        }
        .incorrect {
            color: #dc322f;
            text-shadow: 0 0 10px rgba(220, 50, 47, 0.5);
        }
        #loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #268bd2;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #mute-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(0,0,0,0.05);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 150;
        }
        #mute-btn svg {
             color: #586e75;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .badge-beginner { background-color: #dc322f; }
        .badge-intermediate { background-color: #cd7f32; }
        .badge-advanced { background-color: #c0c0c0; }
        .badge-master { background-color: #ffd700; }
        .badge-ultimate {
            background: linear-gradient(to right, #ef5350, #ff7043, #ffee58, #66bb6a, #42a5f5, #5c6bc0, #ab47bc);
            color: white;
        }
    </style>
</head>
<body>
  <!-- PWA UI -->
 <button id="install-btn" style="position:fixed;bottom:2rem;right:2rem;padding:1em 2em;background:#0ea5e9;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0ea5e988;z-index:1000;display:none;cursor:pointer;font-size:1.1em;">„Ç§„É≥„Çπ„Éà„Éº„É´</button>
  <div id="sw-update" style="display:none;position:fixed;top:1rem;right:1rem;background:#f59e42;color:#fff;padding:.7em 1.5em;border-radius:8px;box-shadow:0 2px 8px #f59e4299;z-index:1000;font-size:1em;">Êñ∞„Éê„Éº„Ç∏„Éß„É≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ<button id="reload-btn" style="margin-left:1em;background:#fff;color:#f59e42;border:none;padding:.3em 1em;border-radius:4px;cursor:pointer;">„É™„É≠„Éº„Éâ</button></div>

<script>
  // Service Worker ÁôªÈå≤Ôºà„Çπ„Ç≥„Éº„ÉóÊåáÂÆöÔºâ
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      let refreshing = false;

      navigator.serviceWorker
        .register('/reframing-game/service-worker.js', { scope: '/reframing-game/' })
        .then((reg) => {
          if (reg.waiting) showUpdateBar(reg);

          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                showUpdateBar(reg);
              }
            });
          });
        })
        .catch((e) => console.error('SW register failed:', e));

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (refreshing) return;
        refreshing = true;
        location.reload();
      });

      function showUpdateBar(reg) {
        const bar = document.getElementById('sw-update');
        if (!bar) return;
        bar.style.display = 'block';
        const btn = document.getElementById('reload-btn');
        if (btn && reg.waiting) {
          btn.onclick = () => reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      }

      // PWA install prompt
      let deferredPrompt;
      const installBtn = document.getElementById('install-btn');
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (installBtn) installBtn.style.display = 'block';
      });
      installBtn?.addEventListener('click', async () => {
        installBtn.style.display = 'none';
        if (deferredPrompt) {
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
          deferredPrompt = null;
        }
      });
    });
  }
</script>

  <!-- Login Page -->
  <div id="login-page" class="page">
    <h1 class="mb-4 text-2xl md:text-5xl">„ÅÇ„Å™„Åü„ÅÆÂêç„Çí<br />ÂÖ•Âäõ„Åõ„Çà</h1>
    <form id="login-form" class="w-10/12 max-w-sm flex flex-col items-center gap-4">
      <input type="text" id="username-input" placeholder="ÂãáËÄÖ„ÅÆÂêçÂâç..." required />
      <button type="submit" class="btn btn-quest">Ê±∫ÂÆö</button>
    </form>
  </div>

  <!-- Top Page -->
  <div id="top-page" class="page hidden">
    <h1 class="mb-8">ÁõÆÊåá„ÅõÔºÅ<br />„É™„Éï„É¨„Éº„Éü„É≥„Ç∞<br />„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„Éà„Éû„Çπ„Çø„ÉºÔºÅ</h1>
    <button id="start-adventure-btn" class="btn btn-quest">ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çã</button>
    <button id="logout-btn" class="mt-4 text-gray-500 underline">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
  </div>

  <!-- Game Page -->
  <div id="game-page" class="page hidden">
    <div id="game-container">
      <!-- Header -->
      <div class="absolute top-4 left-4 stats">SCORE: <span id="score">0</span></div>
      <div class="absolute top-12 left-4 stats text-lg text-amber-600">
        HI-SCORE: <span id="hi-score">0</span>
        <a href="#" id="change-name-link" style="margin-left:10px;font-size:.8em;color:#2563eb;text-decoration:underline;">ÂêçÂâç„ÇíÂ§âÊõ¥</a>
      </div>

      <!-- Ranking -->
      <div id="rank-display" class="absolute top-20 left-4 text-sm leading-6 text-slate-700 bg-white/60 rounded px-3 py-2">
        <div class="font-semibold text-slate-900">„É©„É≥„Ç≠„É≥„Ç∞Ôºà‰∏ä‰Ωç20Ôºâ</div>
        <ol id="rankList" class="list-decimal pl-5 mt-1"></ol>
        <div class="text-xs mt-1">‚Äª „É©„É≥„Ç≠„É≥„Ç∞„ÅØÂåøÂêçID„ÅßË®òÈå≤„Åó„Åæ„Åô„ÄÇ„É°„Éº„É´„ÇÑIPÁ≠â„ÅÆÂÄã‰∫∫ÊÉÖÂ†±„ÅØ‰øùÂ≠ò„Åó„Åæ„Åõ„Çì„ÄÇ</div>
      </div>

      <div class="absolute top-4 right-4 stats">TIME: <span id="time">20</span></div>

      <!-- Word Area -->
      <div id="word-container"><div id="word"></div></div>
      <div id="feedback-indicator"></div>

      <!-- UI -->
      <div id="ui-container">
        <form id="answer-form" class="hidden w-full">
          <div id="input-wrapper">
            <input id="answer-input" class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å´Ë®Ä„ÅÑÊèõ„Åà„Å¶‚Ä¶" autocomplete="off" />
            <button type="button" id="mic-btn" class="btn btn-secondary p-3">üé§</button>
          </div>
          <button type="button" id="pass-btn" class="btn btn-tertiary px-4 py-2">„Éë„Çπ„Åô„Çã (<span id="pass-count">3</span>)</button>
        </form>
      </div>

      <!-- Modal -->
      <div id="modal-overlay">
        <div id="modal-content">
          <h2 id="modal-title" class="text-3xl font-bold mb-4"></h2>
          <p id="new-record-text" class="hidden text-yellow-500 font-bold text-2xl mt-2">üéâ New Record! üéâ</p>
          <p id="modal-text" class="text-lg my-6"></p>
          <div class="flex gap-4">
            <button id="restart-btn" class="btn btn-primary w-full p-3 text-lg">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
            <button id="back-to-top-btn" class="btn btn-tertiary w-full p-3 text-lg">„Éà„ÉÉ„Éó„Å´Êàª„Çã</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mute -->
  <button id="mute-btn" style="position:fixed;bottom:1rem;right:1rem;background:rgba(0,0,0,.05);padding:.5rem;border-radius:50%;z-index:150;">üîä</button>
  <!-- ===== Game JS (non-module) ===== -->
  <script>
    // DOM
    const loginPage = document.getElementById('login-page');
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username-input');
    const topPage = document.getElementById('top-page');
    const gamePage = document.getElementById('game-page');
    const startAdventureBtn = document.getElementById('start-adventure-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const scoreEl = document.getElementById('score');
    const hiScoreEl = document.getElementById('hi-score');
    const rankDisplayEl = document.getElementById('rank-display');
    const timeEl = document.getElementById('time');
    const wordEl = document.getElementById('word');
    const answerInput = document.getElementById('answer-input');
    const answerForm = document.getElementById('answer-form');
    const micBtn = document.getElementById('mic-btn');
    const passBtn = document.getElementById('pass-btn');
    const passCountEl = document.getElementById('pass-count');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalTitle = document.getElementById('modal-title');
    const modalText = document.getElementById('modal-text');
    const newRecordTextEl = document.getElementById('new-record-text');
    const restartBtn = document.getElementById('restart-btn');
    const backToTopBtn = document.getElementById('back-to-top-btn');
    const feedbackIndicator = document.getElementById('feedback-indicator');
    const muteBtn = document.getElementById('mute-btn');

    // Game state
    let score = 0;
    const questionTimeLimit = 20;
    let timeLeft = questionTimeLimit;
    let passCount = 3;
    let timerId = null;
    let currentWord = '';
    let isPlaying = false;
    let isChecking = false;
    let shuffledWords = [];
    let currentUsername = '';
    let isMuted = false;

    // Words
    const words = ["‰ªï‰∫ã„Åß„Éü„Çπ„Çí„Åó„Åü","Á¥ÑÊùü„ÇíÁ†¥„Çâ„Çå„Åü","ÈõªËªä„ÅåÈÅÖÂª∂„Åó„Åü","Èõ®„Åß„Å≥„Åó„ÇáÊø°„Çå„Å´„Å™„Å£„Åü","Ë®àÁîª„ÅåÂ§±Êïó„Åó„Åü","‰∏äÂè∏„Å´ÊÄí„Çâ„Çå„Åü","ÂèãÈÅî„Å®ÂñßÂò©„Åó„Åü","Ë≤°Â∏É„ÇíËêΩ„Å®„Åó„Åü","‰ΩìË™ø„ÅåÊÇ™„ÅÑ","ÂØùÂùä„Åó„Åü","‰∫∫Ââç„ÅßÊÅ•„Çí„Åã„ÅÑ„Åü","ÊÇ™Âè£„ÇíË®Ä„Çè„Çå„Åü","ÊúüÂæÖ„Å´Âøú„Åà„Çâ„Çå„Å™„Åã„Å£„Åü","„Åæ„ÅüÂ§™„Å£„Åü","„Éó„É¨„Çº„É≥„Åå„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„Åã„Å£„Åü","Ê¨≤„Åó„ÅÑ„ÇÇ„ÅÆ„ÅåÂ£≤„ÇäÂàá„Çå„Å¶„ÅÑ„Åü","„Çπ„Éû„Éõ„ÅÆÁîªÈù¢„ÅåÂâ≤„Çå„Åü","Ê•Ω„Åó„Åø„Å´„Åó„Å¶„ÅÑ„Åü„Ç§„Éô„É≥„Éà„Åå‰∏≠Ê≠¢„Å´„Å™„Å£„Åü","ÊñôÁêÜ„Å´Â§±Êïó„Åó„Åü","‰∫∫„Åã„ÇâË™§Ëß£„Åï„Çå„Åü","Ê∏ãÊªû„Å´„ÅØ„Åæ„Å£„Åü","Âøò„ÇåÁâ©„Çí„Åó„Åü","„Éö„ÉÉ„Éà„Å´„ÅÑ„Åü„Åö„Çâ„Åï„Çå„Åü","Ë©¶Âêà„Å´Ë≤†„Åë„Åü","È´™Âûã„ÅåÊ∞ó„Å´ÂÖ•„Çâ„Å™„ÅÑ","‰∏äÂè∏„Å´Âè±„Çâ„Çå„Åü","ÈõªËªä„Çí‰πó„ÇäÈñìÈÅï„Åà„Åü","Êúç„Å´„Ç∑„Éü„Çí„Å§„Åë„Åü","„ÉÜ„Çπ„Éà„ÅÆÁÇπ„ÅåÊÇ™„Åã„Å£„Åü","Â≠ê‰æõ„ÅåË®Ä„ÅÜ„Åì„Å®„ÇíËÅû„Åã„Å™„ÅÑ","Â§úÊ≥£„Åç„Åå„Å≤„Å©„ÅÑ","„ÅîÈ£Ø„ÇíÂÖ®ÁÑ∂È£ü„Åπ„Å™„ÅÑ","„Ç§„É§„Ç§„É§Êúü„ÅåÂ§ßÂ§â","‰ªñ„ÅÆÂ≠ê„Å®ÊØî„Åπ„Å¶ËêΩ„Å°Ëæº„ÇÄ","„ÉØ„É≥„Ç™„ÉöËÇ≤ÂÖê„ÅßÁñ≤„Çå„Åü","„Å§„ÅÑÂ≠ê‰æõ„Å´ÊÄíÈ≥¥„Å£„Å¶„Åó„Åæ„Å£„Åü","ÂÖ¨Âúí„Éá„Éì„É•„Éº„ÅåÊÄñ„ÅÑ","„Éû„ÉûÂèã‰ªò„ÅçÂêà„ÅÑ„ÅåËã¶Êâã","ÂÖÑÂºü„Åí„Çì„Åã„ÅåÁµ∂„Åà„Å™„ÅÑ","Ëá™ÂàÜ„ÅÆÊôÇÈñì„Åå„Å™„ÅÑ","Â≠ê‰æõ„ÅÆÂ•Ω„ÅçÂ´å„ÅÑ„ÅåÊøÄ„Åó„ÅÑ","È†ëÂõ∫","È£Ω„Åç„Å£„ÅΩ„ÅÑ","„Ç±„ÉÅ","ÂøÉÈÖçÊÄß","‰∫∫Ë¶ãÁü•„Çä","ÂÑ™Êüî‰∏çÊñ≠","Áü≠Ê∞ó","ÊÄ†„ÅëËÄÖ","ÊÇ™Âè£„ÇíË®Ä„ÅÜ","‰ªï‰∫ã„Åå„Å§„Åæ„Çâ„Å™„ÅÑ","Ë©ï‰æ°„Åï„Çå„Å™„ÅÑ","Áµ¶Êñô„ÅåÂÆâ„ÅÑ","ËÅ∑Â†¥„ÅÆ‰∫∫ÈñìÈñ¢‰øÇ„ÅåÊÇ™„ÅÑ","ÊòáÈÄ≤„Åß„Åç„Å™„ÅÑ","„Ç¢„Ç§„Éá„Ç¢„ÅåÈÄö„Çâ„Å™„ÅÑ","„ÇÑ„Çä„Åå„ÅÑ„Åå„Å™„ÅÑ","Ëá™‰ø°„Åå„Å™„ÅÑ","Ê±∫Êñ≠Âäõ„Åå„Å™„ÅÑ","ÊÅã‰∫∫„Åå„Åß„Åç„Å™„ÅÑ","ÂèãÈÅî„ÅåÂ∞ë„Å™„ÅÑ","ÈõëË´á„ÅåËã¶Êâã","ÊÑèË¶ã„ÅåÂêà„Çè„Å™„ÅÑ","‰ª≤Èñì„ÅØ„Åö„Çå„Å´„Åï„Çå„Åü","Ë¶ã„ÅüÁõÆ„Åå„Ç≥„É≥„Éó„É¨„ÉÉ„ÇØ„Çπ","ÈÅãÂãï‰∏çË∂≥","ÈÉ®Â±ã„ÅåÊ±ö„ÅÑ","ÊôÇÈñì„Å´„É´„Éº„Ç∫","Áâ©Âøò„Çå„ÅåÊøÄ„Åó„ÅÑ","SNS„Å´Áñ≤„Çå„Åü","Â∞ÜÊù•„Åå‰∏çÂÆâ","Â§¢„Åå„Å™„ÅÑ","‰Ωï„Çí„ÇÑ„Å£„Å¶„ÇÇ‰∏≠ÈÄîÂçäÁ´Ø","‰∫∫„Åã„Çâ„Å©„ÅÜÊÄù„Çè„Çå„Çã„ÅãÊ∞ó„Å´„Å™„Çã","Á©∫Ê∞ó„ÅåË™≠„ÇÅ„Å™„ÅÑ","Ë©±„Åå‰∏ãÊâã","„ÅäÈáë„Åå„Å™„ÅÑ","‰ºë„Åø„Å™„ÅÆ„Å´Áñ≤„Çå„Å¶„ÅÑ„Çã","ÈÅã„ÅåÊÇ™„ÅÑ","È®ô„Åï„Çå„Åü","Ë£èÂàá„Çâ„Çå„Åü","Â´âÂ¶¨„Åó„Å¶„Åó„Åæ„ÅÜ","Â≠§Áã¨„ÇíÊÑü„Åò„Çã","„ÇÑ„ÇãÊ∞ó„ÅåÂá∫„Å™„ÅÑ","„ÅÑ„Å§„ÇÇ„ÇÆ„É™„ÇÆ„É™","ÊúùËµ∑„Åç„Çã„ÅÆ„ÅåËæõ„ÅÑ","‰∫∫„Å´È†º„Çã„ÅÆ„ÅåËã¶Êâã","Êñ≠„Çå„Å™„ÅÑ","ÂÆåÁíß‰∏ªÁæ©„ÅßÁñ≤„Çå„Çã","ËÄÉ„Åà„Åô„Åé„Çã","ÂÖ´ÊñπÁæé‰∫∫","„Éç„Ç¨„ÉÜ„Ç£„ÉñÊÄùËÄÉ","„Ç≥„É≥„Éó„É¨„ÉÉ„ÇØ„Çπ„ÅÆÂ°ä","„Åô„Åê„Å´Ë´¶„ÇÅ„Çã","Ë®àÁîªÊÄß„Åå„Å™„ÅÑ","‰∏âÊó•Âùä‰∏ª","Èù¢ÂÄí„Åè„Åï„Åå„Çä","Âè£‰∏ãÊâã","ÊñπÂêëÈü≥Áó¥","ÈÅãÂãïÁ•ûÁµå„ÅåÊÇ™„ÅÑ","Â≠ó„ÅåÊ±ö„ÅÑ","Áµµ„Åå‰∏ãÊâã","Ê≠å„Åå‰∏ãÊâã"];

    // BGM (Tone.js)
    const topPageSynth = new Tone.PolySynth(Tone.Synth,{oscillator:{type:'fatsawtooth'},envelope:{attack:.1,decay:.2,sustain:.6,release:1}}).toDestination();
    const topPageLoop = new Tone.Sequence((time,note)=>{ topPageSynth.triggerAttackRelease(note,'4n',time); }, ['C3',['E3','G3'],'F3',['G3','B3']], '2n');
    const gameSynth = new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:.005,decay:.1,sustain:.3,release:1}}).toDestination();
    const gamePattern = new Tone.Pattern((time,note)=>{ gameSynth.triggerAttackRelease(note,'8n',time); }, ['C5','E5','G5','A5','G5','E5'], 'upDown'); gamePattern.interval='8n';
    const gameOverSynth = new Tone.PolySynth(Tone.Synth,{oscillator:{type:'amsine'},envelope:{attack:.5,decay:.2,sustain:.8,release:2}}).toDestination();
    const newRecordSynth = new Tone.PolySynth(Tone.Synth,{oscillator:{type:'triangle'}}).toDestination();

    // Speech
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition){
      recognition = new SpeechRecognition();
      recognition.lang='ja-JP'; recognition.interimResults=false; recognition.continuous=false;
      recognition.onresult = e => { const t = e.results[0][0].transcript; answerInput.value=t; answerForm.dispatchEvent(new Event('submit',{cancelable:true,bubbles:true})); };
      recognition.onerror = e => { console.error('Speech error:', e.error); micBtn.disabled=false; };
      recognition.onend = () => { if(isPlaying && !isChecking) micBtn.disabled=false; };
    } else { micBtn.style.display='none'; }

    // Utils
    function shuffleWords(){ shuffledWords = [...words].sort(()=>0.5-Math.random()); }

    // ÂêçÂâçÂ§âÊõ¥
    document.getElementById('change-name-link').addEventListener('click', (e)=>{
      e.preventDefault(); const v = prompt('Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà16ÊñáÂ≠ó‰ª•ÂÜÖÔºâ'); if(!v) return;
      const trimmed = v.trim().slice(0,16); if(!trimmed) return;
      localStorage.setItem('rg_username', trimmed); alert(`ÂêçÂâç„Çí„Äå${trimmed}„Äç„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`); location.reload();
    });

    // „Éê„ÉÉ„Ç∏Ë°®Á§∫
    function updateRankDisplay(currentScore){
      const p = (currentScore / 1000) * 100;
      let rank={title:'„É™„Éï„É¨„Éº„Éü„É≥„Ç∞ÂàùÂøÉËÄÖ',badgeClass:'badge-beginner'};
      if(p>=90) rank={title:'„É™„Éï„É¨„Éº„Éü„É≥„Ç∞„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„Éà„Éû„Çπ„Çø„Éº',badgeClass:'badge-ultimate'};
      else if(p>=70) rank={title:'„É™„Éï„É¨„Éº„Éü„É≥„Ç∞„Éû„Çπ„Çø„Éº',badgeClass:'badge-master'};
      else if(p>=50) rank={title:'„É™„Éï„É¨„Éº„Éü„É≥„Ç∞‰∏äÁ¥öËÄÖ',badgeClass:'badge-advanced'};
      else if(p>=20) rank={title:'„É™„Éï„É¨„Éº„Éü„É≥„Ç∞‰∏≠Á¥öËÄÖ',badgeClass:'badge-intermediate'};
      rankDisplayEl.querySelector('.font-semibold').innerHTML = `<span class="badge ${rank.badgeClass}">${rank.title}</span>`;
    }

    function loadHiScore(){
      const hi = localStorage.getItem(`reframingHiScore_${currentUsername}`) || 0;
      hiScoreEl.textContent = hi; updateRankDisplay(parseInt(hi,10)); return parseInt(hi,10);
    }

    function init(){
      gamePage.classList.add('hidden'); topPage.classList.add('hidden'); loginPage.classList.remove('hidden'); modalOverlay.style.display='none';
      if (Tone.Transport.state==='started') Tone.Transport.stop(); gameOverSynth.releaseAll();
    }

    function showTopPage(){
      loginPage.classList.add('hidden'); gamePage.classList.add('hidden'); topPage.classList.remove('hidden');
      if (Tone.Transport.state==='started') Tone.Transport.stop();
      gamePattern.stop(); topPageLoop.start(0); Tone.Transport.start(); loadHiScore();
    }

    async function startGame(){
      if (Tone.context.state!=='running') await Tone.start();
      if (Tone.Transport.state==='started') Tone.Transport.stop();
      topPageLoop.stop(); gamePattern.start(0); Tone.Transport.start();

      score=0; passCount=3; scoreEl.textContent=score; passCountEl.textContent=passCount; passBtn.disabled=false; newRecordTextEl.classList.add('hidden');
      shuffleWords(); loadHiScore(); modalOverlay.style.display='none';
      isPlaying=true; isChecking=false; answerForm.classList.remove('hidden'); answerInput.focus(); showNewWord();
    }

    function showNewWord(){
      clearInterval(timerId); wordEl.classList.remove('paused-animation'); isChecking=false;
      answerInput.value=''; answerInput.disabled=false; micBtn.disabled=false; passBtn.disabled = passCount<=0; answerInput.focus();
      if (shuffledWords.length===0) shuffleWords();
      currentWord = shuffledWords.pop(); wordEl.textContent=currentWord;
      wordEl.style.animation='none'; void wordEl.offsetWidth; wordEl.style.animation=`come-closer ${questionTimeLimit}s linear forwards`;
      startTimer();
    }

    function startTimer(){
      timeLeft=questionTimeLimit; timeEl.textContent=timeLeft;
      timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ clearInterval(timerId); showFeedback(false); setTimeout(gameOver,1000);} },1000);
    }
    function resumeTimer(){
      clearInterval(timerId);
      timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft; if(timeLeft<=0){ clearInterval(timerId); showFeedback(false); setTimeout(gameOver,1000);} },1000);
    }

    async function handleSubmit(e){
      e.preventDefault(); if(!isPlaying || isChecking) return;
      const userAnswer = answerInput.value.trim(); if(!userAnswer) return;
      clearInterval(timerId); isChecking=true; answerInput.disabled=true; micBtn.disabled=true; passBtn.disabled=true;
      const original = micBtn.innerHTML; micBtn.innerHTML = '<div id="loading-spinner"></div>';
      try{
        const result = await checkReframing(currentWord, userAnswer);
        if (result.isGoodReframing){ wordEl.classList.add('paused-animation'); showFeedback(true); score+=10; scoreEl.textContent=score; setTimeout(showNewWord,1000); }
        else { showFeedback(false); setTimeout(()=>{ isChecking=false; answerInput.disabled=false; micBtn.disabled=false; passBtn.disabled = passCount<=0; answerInput.focus(); resumeTimer();},1000); }
      }catch(err){ console.error('check error:',err); showFeedback(false); setTimeout(()=>{ isChecking=false; answerInput.disabled=false; micBtn.disabled=false; passBtn.disabled = passCount<=0; answerInput.focus(); resumeTimer();},1000); }
      finally{ micBtn.innerHTML = original; }
    }

    function handlePass(){ if(!isPlaying || isChecking || passCount<=0) return; passCount--; passCountEl.textContent=passCount; gameSynth.triggerAttackRelease('A4','8n'); clearInterval(timerId); showNewWord(); }

    function showFeedback(ok){ feedbackIndicator.textContent = ok?'Nice!':'Hmm...'; feedbackIndicator.classList.remove('correct','incorrect'); feedbackIndicator.classList.add(ok?'correct':'incorrect'); feedbackIndicator.style.opacity=1; setTimeout(()=>{feedbackIndicator.style.opacity=0;},1000); }

    async function checkReframing(originalText, reframedText){
      const apiKey = "AIzaSyCYAKKl9AzwuAnEMOPX7rDRSsWmTefNyro";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      const prompt = `„ÅÇ„Å™„Åü„ÅØ„É™„Éï„É¨„Éº„Éü„É≥„Ç∞Âà§ÂÆö„ÅÆÂ∞ÇÈñÄÂÆ∂„Åß„Åô„ÄÇ„Éç„Ç¨„ÉÜ„Ç£„Éñ„Å™Ë®ÄËëâ„Äå${originalText}„Äç„Åå„ÄÅ„É™„Éï„É¨„Éº„Éü„É≥„Ç∞Ê°à„Äå${reframedText}„Äç„Å´„Çà„Å£„Å¶„ÄÅÂÖÉ„ÅÆÁä∂Ê≥Å„ÇíË∏è„Åæ„Åà„Å§„Å§„Éù„Ç∏„ÉÜ„Ç£„Éñ„Å™Ë¶ñÁÇπ„Å´„ÅÜ„Åæ„ÅèÂ§âÊèõ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÇíÂà§ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂçò„Å™„ÇãÂê¶ÂÆö„ÇÑÁÑ°Èñ¢‰øÇ„Å™Áô∫Ë®Ä„ÅØ‰∏çÈÅ©Âàá„Åß„Åô„ÄÇÂà§ÂÆöÁµêÊûú„Çí "good" „Åæ„Åü„ÅØ "bad" „ÅÆ‰∏ÄË®Ä„Åß„ÄÅJSONÂΩ¢ÂºèÔºà‰æã: {"result": "good"}Ôºâ„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;
      const payload = { contents:[{ parts:[{ text: prompt }]}], generationConfig:{ responseMimeType:"application/json" } };
      try{
        const res = await fetch(apiUrl,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        if(!res.ok) throw new Error(res.status);
        const json = await res.json();
        const text = json.candidates?.[0]?.content?.parts?.[0]?.text || '{"result":"bad"}';
        const parsed = JSON.parse(text);
        return { isGoodReframing: parsed.result === 'good' };
      }catch(e){ console.error("Gemini API Error:",e); return { isGoodReframing:false }; }
    }

    async function gameOver(){
      isPlaying=false; clearInterval(timerId); wordEl.classList.add('paused-animation'); answerForm.classList.add('hidden');
      if (Tone.Transport.state==='started') Tone.Transport.stop();
      gamePattern.stop(); gameOverSynth.triggerAttackRelease(['C3','E3','G3'],'2n');
      modalTitle.textContent='„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº'; modalText.textContent=`„ÅÇ„Å™„Åü„ÅÆÊúÄÁµÇ„Çπ„Ç≥„Ç¢„ÅØ ${score} ÁÇπ„Åß„ÅôÔºÅ`;

      const hiBefore = loadHiScore(); let best = hiBefore;
      if (score > hiBefore){
        localStorage.setItem(`reframingHiScore_${currentUsername}`, score);
        newRecordTextEl.classList.remove('hidden'); loadHiScore();
        const now = Tone.now(); newRecordSynth.triggerAttackRelease(['C5','E5','G5','C6'],'8n',now); newRecordSynth.triggerAttackRelease(['E6'],'8n',now+0.2);
        best = score;
      } else { newRecordTextEl.classList.add('hidden'); }

      const displayName = (typeof currentUsername==='string' && currentUsername) || localStorage.getItem('rg_username') || 'ÂåøÂêç';
      if (typeof window.saveScore === 'function'){
        try{ await window.saveScore(displayName.toString().slice(0,16), Number(best)); }
        catch(e){ console.error('saveScore failed:', e); }
      } else {
        console.warn('window.saveScore „ÅåÊú™ÂÆöÁæ©„Åß„ÅôÔºàFirebase„É¢„Ç∏„É•„Éº„É´„ÅÆË™≠„ÅøËæº„ÅøÈ†Ü„ÇíÁ¢∫Ë™çÔºâ');
      }
      modalOverlay.style.display='flex';
    }

    function toggleMute(){ isMuted=!isMuted; Tone.Destination.mute=isMuted; muteBtn.textContent = isMuted?'üîá':'üîä'; }

    // Events
    loginForm.addEventListener('submit', async (e)=>{ e.preventDefault(); currentUsername = usernameInput.value.trim(); if(currentUsername){ localStorage.setItem('reframingCurrentUser', currentUsername); if(Tone.context.state!=='running') await Tone.start(); showTopPage(); }});
    logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('reframingCurrentUser'); usernameInput.value=''; init(); });
    startAdventureBtn.addEventListener('click', ()=>{ topPage.classList.add('hidden'); gamePage.classList.remove('hidden'); startGame(); });
    restartBtn.addEventListener('click', ()=> startGame());
    backToTopBtn.addEventListener('click', ()=>{ gamePage.classList.add('hidden'); showTopPage(); });
    answerForm.addEventListener('submit', handleSubmit);
    micBtn.addEventListener('click', ()=>{ if(recognition && !isChecking){ micBtn.disabled=true; recognition.start(); }});
    passBtn.addEventListener('click', handlePass);
    muteBtn.addEventListener('click', toggleMute);

    // Initial
    window.onload = ()=>{ currentUsername = localStorage.getItem('reframingCurrentUser'); if(currentUsername){ usernameInput.value=currentUsername; showTopPage(); } else { init(); } };
  </script>

<!-- ===== Firebase + Ranking (module) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, serverTimestamp,
    getDocs, collection, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAjMznd4LPaSy3KcjVj5gbZnyllMM8XigU",
    authDomain: "reframing-game.firebaseapp.com",
    projectId: "reframing-game",
    storageBucket: "reframing-game.firebasestorage.app",
    messagingSenderId: "1082764235640",
    appId: "1:1082764235640:web:fef4b92b13a80ecdf5ae8d",
    measurementId: "G-SX62V2ND76"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  let uid = null;
  try {
    const cred = await signInAnonymously(auth);
    uid = cred.user.uid;
  } catch(e) {
    console.error('Anonymous sign-in failed:', e);
  }

  async function saveScore(username, score = 0) {
    if (!uid) return console.warn('no uid');
    const name = (username || 'ÂåøÂêç').toString().slice(0,16);
    try {
      await setDoc(doc(db, 'scores', uid), {
        username: name,
        score: Number(score),
        createdAt: serverTimestamp()
      }, { merge: true });
      await loadRanking();
    } catch(e) {
      console.error('saveScore error:', e);
    }
  }

  async function loadRanking() {
    const list = document.getElementById('rankList');
    if (!list) return;
    list.innerHTML = '';
    try {
      const snap = await getDocs(
        query(collection(db, 'scores'), orderBy('score', 'desc'), limit(20))
      );
      let i = 1;
      snap.forEach(d => {
        const x = d.data();
        const li = document.createElement('li');
        li.textContent = `${i}. ${x.username || 'ÂåøÂêç'} ‚Äî ${x.score ?? 0}`;
        list.appendChild(li);
        i++;
      });
    } catch(e) {
      console.error('loadRanking error:', e);
    }
  }

  window.saveScore = saveScore;
  window.loadRanking = loadRanking;
  loadRanking();
</script>


<small style="display:block;text-align:center;color:#aab;margin:12px 0;">
  „É©„É≥„Ç≠„É≥„Ç∞„ÅØÂåøÂêçID„ÅßË®òÈå≤„Åó„Åæ„Åô„ÄÇ„É°„Éº„É´„ÇÑIPÁ≠â„ÅÆÂÄã‰∫∫ÊÉÖÂ†±„ÅØ‰øùÂ≠ò„Åó„Åæ„Åõ„Çì„ÄÇ
</small>
</body>
</html>