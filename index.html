<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨€è‘‰ã®ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ã‚²ãƒ¼ãƒ </title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0ea5e9"/>
    <link rel="manifest" href="/reframing-game/manifest.json">

    <!-- iOSå‘ã‘ã‚¢ã‚¤ã‚³ãƒ³ãƒ»metaã‚¿ã‚° -->
    <link rel="apple-touch-icon" sizes="192x192" href="/reframing-game/images/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/reframing-game/images/icons/icon-512x512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Reframing Game">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Orbitron:wght@700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #fdf6e3;
            color: #586e75;
            overflow: hidden;
        }
        .page {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        #login-page, #top-page {
            background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url("data:image/svg+xml,%3csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg' style='image-rendering: pixelated;'%3e%3crect fill='%2377b5fe' x='0' y='0' width='100' height='60'/%3e%3crect fill='%23fecb2e' x='10' y='10' width='20' height='20'/%3e%3crect fill='%2342a5f5' x='0' y='60' width='100' height='40'/%3e%3crect fill='%2320663f' x='5' y='50' width='15' height='10'/%3e%3crect fill='%232E8B57' x='25' y='45' width='20' height='15'/%3e%3crect fill='%2320663f' x='50' y='48' width='10' height='12'/%3e%3crect fill='%232E8B57' x='65' y='42' width='15' height='18'/%3e%3crect fill='%2320663f' x='85' y='52' width='10' height='8'/%3e%3c/svg%3e");
            background-size: cover;
            background-position: center;
            text-align: center;
        }
        #hero-svg {
            width: 150px;
            height: auto;
            margin-bottom: 2rem;
            animation: hero-bob 2s ease-in-out infinite;
        }
        @keyframes hero-bob {
            0% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-8px);
            }
            100% {
                transform: translateY(0);
            }
        }
        #top-page h1, #login-page h1 {
            font-family: 'MedievalSharp', cursive;
            font-size: 3.5rem;
            color: #fdf6e3;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.7);
        }
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            position: relative;
            perspective: 800px;
        }
        #word-container {
            position: absolute;
            top: 25%;
            width: 100%;
            height: 100px;
            perspective: 500px;
        }
        #word {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: #dc322f;
            text-shadow: 0 0 8px rgba(220, 50, 47, 0.5);
            transform-style: preserve-3d;
            animation: come-closer 20s linear forwards;
        }
        @keyframes come-closer {
            from {
                transform: translateZ(-2000px) scale(1.1);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            to {
                transform: translateZ(100px) scale(1.2);
                opacity: 1;
            }
        }
        .paused-animation {
            animation-play-state: paused !important;
        }
        #ui-container {
            position: absolute;
            bottom: 10%;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .stats {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #268bd2;
            text-shadow: none;
        }
        #answer-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 0.75rem;
        }
        #input-wrapper {
             display: flex;
             width: 100%;
             gap: 0.5rem;
        }
        #answer-input, #username-input {
            background-color: #eee8d5;
            border: 1px solid #93a1a1;
            color: #073642;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
        }
        #answer-input::placeholder, #username-input::placeholder {
            color: #93a1a1;
        }
        .btn {
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            border: none;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #2aa198;
            color: #fdf6e3;
        }
        .btn-secondary {
            background-color: #cb4b16;
            color: #fdf6e3;
        }
        .btn-tertiary {
            background-color: #6c71c4;
            color: #fdf6e3;
        }
        .btn-quest {
            background-color: #855d3c;
            color: #fdf6e3;
            font-family: 'MedievalSharp', cursive;
            font-size: 1.5rem;
            padding: 1rem 2rem;
            border: 2px solid #654321;
            box-shadow: 0 4px 0 #654321;
        }
        .btn-quest:hover:not(:disabled) {
            background-color: #a07b56;
            box-shadow: 0 2px 0 #654321;
        }
        #modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #modal-content {
            background: #fdf6e3;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #2aa198;
            box-shadow: 0 0 20px rgba(42, 161, 152, 0.4);
        }
        #feedback-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.5s ease-out;
            z-index: 20;
        }
        .correct {
            color: #859900;
            text-shadow: 0 0 10px rgba(133, 153, 0, 0.5);
        }
        .incorrect {
            color: #dc322f;
            text-shadow: 0 0 10px rgba(220, 50, 47, 0.5);
        }
        #loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #268bd2;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #mute-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(0,0,0,0.05);
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 150;
        }
        #mute-btn svg {
             color: #586e75;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.9rem;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .badge-beginner { background-color: #dc322f; }
        .badge-intermediate { background-color: #cd7f32; }
        .badge-advanced { background-color: #c0c0c0; }
        .badge-master { background-color: #ffd700; }
        .badge-ultimate {
            background: linear-gradient(to right, #ef5350, #ff7043, #ffee58, #66bb6a, #42a5f5, #5c6bc0, #ab47bc);
            color: white;
        }
    </style>
</head>
<body>
<button id="install-btn" style="position:fixed;bottom:2rem;right:2rem;padding:1em 2em;background:#0ea5e9;color:#fff;border:none;border-radius:8px;box-shadow:0 2px 8px #0ea5e988;z-index:1000;display:none;cursor:pointer;font-size:1.1em;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
<div id="sw-update" style="display:none;position:fixed;top:1rem;right:1rem;background:#f59e42;color:#fff;padding:0.7em 1.5em;border-radius:8px;box-shadow:0 2px 8px #f59e4299;z-index:1000;font-size:1em;">æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚<button id="reload-btn" style="margin-left:1em;background:#fff;color:#f59e42;border:none;padding:0.3em 1em;border-radius:4px;cursor:pointer;">ãƒªãƒ­ãƒ¼ãƒ‰</button></div>
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
                    let refreshing = false;
                    navigator.serviceWorker.register('/reframing-game/service-worker.js').then(reg => {
                        // SWæ›´æ–°é€šçŸ¥
                        if (reg.waiting) showUpdateBar(reg);
                        reg.addEventListener('updatefound', () => {
                            const newSW = reg.installing;
                            newSW.addEventListener('statechange', () => {
                                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateBar(reg);
                                }
                            });
                        });
                    });
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        if (refreshing) return;
                        window.location.reload();
                        refreshing = true;
                    });
                    function showUpdateBar(reg) {
                        const bar = document.getElementById('sw-update');
                        bar.style.display = 'block';
                        document.getElementById('reload-btn').onclick = () => {
                            reg.waiting.postMessage({type:'SKIP_WAITING'});
                        };
                    }

                    // beforeinstallprompt & ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³
                    let deferredPrompt;
                    const installBtn = document.getElementById('install-btn');
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        deferredPrompt = e;
                        installBtn.style.display = 'block';
                    });
                    installBtn.addEventListener('click', async () => {
                        installBtn.style.display = 'none';
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            await deferredPrompt.userChoice;
                            deferredPrompt = null;
                        }
                    });
        });
    }
</script>
    <!-- Login Page -->
    <div id="login-page" class="page">
        <h1 class="mb-4 text-2xl md:text-5xl">æ±ã®åã‚’<br>å…¥åŠ›ã›ã‚ˆ</h1>
        <form id="login-form" class="w-10/12 max-w-sm flex flex-col items-center gap-4">
            <input type="text" id="username-input" placeholder="å‹‡è€…ã®åå‰..." required>
            <button type="submit" class="btn btn-quest">æ±ºå®š</button>
        </form>
    </div>

    <!-- Top Page -->
    <div id="top-page" class="page hidden">
        <svg id="hero-svg" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="image-rendering: pixelated;">
            <rect fill="#654321" x="6" y="2" width="4" height="1"/>
            <rect fill="#fdf6e3" x="5" y="3" width="6" height="3"/>
            <rect fill="#586e75" x="6" y="3" width="1" height="1"/>
            <rect fill="#586e75" x="9" y="3" width="1" height="1"/>
            <rect fill="#dc322f" x="4" y="6" width="8" height="4"/>
            <rect fill="#cb4b16" x="3" y="7" width="1" height="2"/>
            <rect fill="#c0c0c0" x="2" y="6" width="1" height="4"/>
            <rect fill="#654321" x="6" y="10" width="1" height="3"/>
            <rect fill="#654321" x="9" y="10" width="1" height="3"/>
        </svg>
        <h1 class="mb-8">ç›®æŒ‡ã›ï¼<br>ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°<br>ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒã‚¹ã‚¿ãƒ¼ï¼</h1>
        <button id="start-adventure-btn" class="btn btn-quest">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
        <button id="logout-btn" class="mt-4 text-gray-500 underline">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <!-- Game Page -->
    <div id="game-page" class="page hidden">
        <div id="game-container">
            <!-- Header: Score and Time -->
            <div class="absolute top-4 left-4 stats">
    SCORE: <span id="score">0</span>
</div>
<div class="absolute top-12 left-4 stats text-lg text-amber-600">
    HI-SCORE: <span id="hi-score">0</span>
    <a href="#" id="change-name-link" style="margin-left: 10px; font-size: 0.8em; color: blue; text-decoration: underline;">
        åå‰ã‚’å¤‰æ›´
    </a>
</div>
<div id="rank-display" class="absolute top-20 left-4 text-lg"></div>
<div class="absolute top-4 right-4 stats">TIME: <span id="time">20</span></div>

            <!-- Word Animation Area -->
            <div id="word-container">
                <div id="word"></div>
            </div>
            
            <div id="feedback-indicator"></div>

            <!-- UI Controls -->
            <div id="ui-container">
                <form id="answer-form" class="hidden w-full">
                    <div id="input-wrapper">
                        <input type="text" id="answer-input" class="w-full p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" placeholder="ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è¨€ã„æ›ãˆã¦..." autocomplete="off">
                        <button type="button" id="mic-btn" class="btn btn-secondary p-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                        </button>
                    </div>
                    <button type="button" id="pass-btn" class="btn btn-tertiary px-4 py-2">ãƒ‘ã‚¹ã™ã‚‹ (<span id="pass-count">3</span>)</button>
                </form>
            </div>

            <!-- Modal -->
            <div id="modal-overlay">
                <div id="modal-content">
                    <h2 id="modal-title" class="text-3xl font-bold mb-4"></h2>
                    <p id="new-record-text" class="hidden text-yellow-500 font-bold text-2xl mt-2">ğŸ‰ New Record! ğŸ‰</p>
                    <p id="modal-text" class="text-lg my-6"></p>
                    <div class="flex gap-4">
                        <button id="restart-btn" class="btn btn-primary w-full p-3 text-lg">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
                        <button id="back-to-top-btn" class="btn btn-tertiary w-full p-3 text-lg">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mute Button (Global) -->
    <button id="mute-btn">
        <svg id="speaker-on" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        <svg id="speaker-off" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
    </button>

    <script>
        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username-input');
        const topPage = document.getElementById('top-page');
        const gamePage = document.getElementById('game-page');
        const startAdventureBtn = document.getElementById('start-adventure-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const scoreEl = document.getElementById('score');
        const hiScoreEl = document.getElementById('hi-score');
        const rankDisplayEl = document.getElementById('rank-display');
        const timeEl = document.getElementById('time');
        const wordEl = document.getElementById('word');
        const answerInput = document.getElementById('answer-input');
        const answerForm = document.getElementById('answer-form');
        const micBtn = document.getElementById('mic-btn');
        const passBtn = document.getElementById('pass-btn');
        const passCountEl = document.getElementById('pass-count');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const newRecordTextEl = document.getElementById('new-record-text');
        const restartBtn = document.getElementById('restart-btn');
        const backToTopBtn = document.getElementById('back-to-top-btn');
        const feedbackIndicator = document.getElementById('feedback-indicator');
        const muteBtn = document.getElementById('mute-btn');
        const speakerOnIcon = document.getElementById('speaker-on');
        const speakerOffIcon = document.getElementById('speaker-off');

        // --- Game State ---
        let score = 0;
        const questionTimeLimit = 20;
        let timeLeft = questionTimeLimit;
        let passCount = 3;
        let timerId = null;
        let currentWord = '';
        let isPlaying = false;
        let isChecking = false;
        let isMuted = false;
        let shuffledWords = [];
        let currentUsername = '';

        // --- Game Data ---
        const words = [
            "ä»•äº‹ã§ãƒŸã‚¹ã‚’ã—ãŸ", "ç´„æŸã‚’ç ´ã‚‰ã‚ŒãŸ", "é›»è»ŠãŒé…å»¶ã—ãŸ", "é›¨ã§ã³ã—ã‚‡æ¿¡ã‚Œã«ãªã£ãŸ", "è¨ˆç”»ãŒå¤±æ•—ã—ãŸ", "ä¸Šå¸ã«æ€’ã‚‰ã‚ŒãŸ", "å‹é”ã¨å–§å˜©ã—ãŸ", "è²¡å¸ƒã‚’è½ã¨ã—ãŸ", "ä½“èª¿ãŒæ‚ªã„", "å¯åŠã—ãŸ", "äººå‰ã§æ¥ã‚’ã‹ã„ãŸ", "æ‚ªå£ã‚’è¨€ã‚ã‚ŒãŸ", "æœŸå¾…ã«å¿œãˆã‚‰ã‚Œãªã‹ã£ãŸ", "ã¾ãŸå¤ªã£ãŸ", "ãƒ—ãƒ¬ã‚¼ãƒ³ãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸ", "æ¬²ã—ã„ã‚‚ã®ãŒå£²ã‚Šåˆ‡ã‚Œã¦ã„ãŸ", "ã‚¹ãƒãƒ›ã®ç”»é¢ãŒå‰²ã‚ŒãŸ", "æ¥½ã—ã¿ã«ã—ã¦ã„ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒä¸­æ­¢ã«ãªã£ãŸ", "æ–™ç†ã«å¤±æ•—ã—ãŸ", "äººã‹ã‚‰èª¤è§£ã•ã‚ŒãŸ", "æ¸‹æ»ã«ã¯ã¾ã£ãŸ", "å¿˜ã‚Œç‰©ã‚’ã—ãŸ", "ãƒšãƒƒãƒˆã«ã„ãŸãšã‚‰ã•ã‚ŒãŸ", "è©¦åˆã«è² ã‘ãŸ", "é«ªå‹ãŒæ°—ã«å…¥ã‚‰ãªã„", "ä¸Šå¸ã«å±ã‚‰ã‚ŒãŸ", "é›»è»Šã‚’ä¹—ã‚Šé–“é•ãˆãŸ", "æœã«ã‚·ãƒŸã‚’ã¤ã‘ãŸ", "ãƒ†ã‚¹ãƒˆã®ç‚¹ãŒæ‚ªã‹ã£ãŸ", "å­ä¾›ãŒè¨€ã†ã“ã¨ã‚’èã‹ãªã„", "å¤œæ³£ããŒã²ã©ã„", "ã”é£¯ã‚’å…¨ç„¶é£Ÿã¹ãªã„", "ã‚¤ãƒ¤ã‚¤ãƒ¤æœŸãŒå¤§å¤‰", "ä»–ã®å­ã¨æ¯”ã¹ã¦è½ã¡è¾¼ã‚€", "ãƒ¯ãƒ³ã‚ªãƒšè‚²å…ã§ç–²ã‚ŒãŸ", "ã¤ã„å­ä¾›ã«æ€’é³´ã£ã¦ã—ã¾ã£ãŸ", "å…¬åœ’ãƒ‡ãƒ“ãƒ¥ãƒ¼ãŒæ€–ã„", "ãƒãƒå‹ä»˜ãåˆã„ãŒè‹¦æ‰‹", "å…„å¼Ÿã’ã‚“ã‹ãŒçµ¶ãˆãªã„", "è‡ªåˆ†ã®æ™‚é–“ãŒãªã„", "å­ä¾›ã®å¥½ãå«Œã„ãŒæ¿€ã—ã„", "é ‘å›º", "é£½ãã£ã½ã„", "ã‚±ãƒ", "å¿ƒé…æ€§", "äººè¦‹çŸ¥ã‚Š", "å„ªæŸ”ä¸æ–­", "çŸ­æ°—", "æ€ ã‘è€…", "æ‚ªå£ã‚’è¨€ã†", "ä»•äº‹ãŒã¤ã¾ã‚‰ãªã„", "è©•ä¾¡ã•ã‚Œãªã„", "çµ¦æ–™ãŒå®‰ã„", "è·å ´ã®äººé–“é–¢ä¿‚ãŒæ‚ªã„", "æ˜‡é€²ã§ããªã„", "ã‚¢ã‚¤ãƒ‡ã‚¢ãŒé€šã‚‰ãªã„", "ã‚„ã‚ŠãŒã„ãŒãªã„", "è‡ªä¿¡ãŒãªã„", "æ±ºæ–­åŠ›ãŒãªã„", "æ‹äººãŒã§ããªã„", "å‹é”ãŒå°‘ãªã„", "é›‘è«‡ãŒè‹¦æ‰‹", "æ„è¦‹ãŒåˆã‚ãªã„", "ä»²é–“ã¯ãšã‚Œã«ã•ã‚ŒãŸ", "è¦‹ãŸç›®ãŒã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹", "é‹å‹•ä¸è¶³", "éƒ¨å±‹ãŒæ±šã„", "æ™‚é–“ã«ãƒ«ãƒ¼ã‚º", "ç‰©å¿˜ã‚ŒãŒæ¿€ã—ã„", "SNSã«ç–²ã‚ŒãŸ", "å°†æ¥ãŒä¸å®‰", "å¤¢ãŒãªã„", "ä½•ã‚’ã‚„ã£ã¦ã‚‚ä¸­é€”åŠç«¯", "äººã‹ã‚‰ã©ã†æ€ã‚ã‚Œã‚‹ã‹æ°—ã«ãªã‚‹", "ç©ºæ°—ãŒèª­ã‚ãªã„", "è©±ãŒä¸‹æ‰‹", "ãŠé‡‘ãŒãªã„", "ä¼‘ã¿ãªã®ã«ç–²ã‚Œã¦ã„ã‚‹", "é‹ãŒæ‚ªã„", "é¨™ã•ã‚ŒãŸ", "è£åˆ‡ã‚‰ã‚ŒãŸ", "å«‰å¦¬ã—ã¦ã—ã¾ã†", "å­¤ç‹¬ã‚’æ„Ÿã˜ã‚‹", "ã‚„ã‚‹æ°—ãŒå‡ºãªã„", "ã„ã¤ã‚‚ã‚®ãƒªã‚®ãƒª", "æœèµ·ãã‚‹ã®ãŒè¾›ã„", "äººã«é ¼ã‚‹ã®ãŒè‹¦æ‰‹", "æ–­ã‚Œãªã„", "å®Œç’§ä¸»ç¾©ã§ç–²ã‚Œã‚‹", "è€ƒãˆã™ãã‚‹", "å…«æ–¹ç¾äºº", "ãƒã‚¬ãƒ†ã‚£ãƒ–æ€è€ƒ", "ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹ã®å¡Š", "ã™ãã«è«¦ã‚ã‚‹", "è¨ˆç”»æ€§ãŒãªã„", "ä¸‰æ—¥åŠä¸»", "é¢å€’ãã•ãŒã‚Š", "å£ä¸‹æ‰‹", "æ–¹å‘éŸ³ç—´", "é‹å‹•ç¥çµŒãŒæ‚ªã„", "å­—ãŒæ±šã„", "çµµãŒä¸‹æ‰‹", "æ­ŒãŒä¸‹æ‰‹"
        ];

        // --- BGM Setup (Tone.js) ---
        const topPageSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fatsawtooth' }, envelope: { attack: 0.1, decay: 0.2, sustain: 0.6, release: 1 } }).toDestination();
        const topPageLoop = new Tone.Sequence((time, note) => {
            topPageSynth.triggerAttackRelease(note, '4n', time);
        }, ['C3', ['E3', 'G3'], 'F3', ['G3', 'B3']], '2n');

        const gameSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const gamePattern = new Tone.Pattern((time, note) => {
            gameSynth.triggerAttackRelease(note, '8n', time);
        }, ['C5', 'E5', 'G5', 'A5', 'G5', 'E5'], 'upDown');
        gamePattern.interval = '8n';

        const gameOverSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'amsine' }, envelope: { attack: 0.5, decay: 0.2, sustain: 0.8, release: 2 } }).toDestination();
        const newRecordSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' } }).toDestination();

        // --- Web Speech API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                answerInput.value = transcript;
                answerForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            };
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micBtn.disabled = false;
            };
            recognition.onend = () => {
                if (isPlaying && !isChecking) {
                    micBtn.disabled = false;
                }
            };
        } else {
            micBtn.style.display = 'none';
        }

        // --- Game Logic ---
        function shuffleWords() {
            shuffledWords = [...words].sort(() => 0.5 - Math.random());
        }
        
        function updateRankDisplay(currentScore) {
            const maxScore = 1000; // Theoretical max for 100 questions
            const percentage = (currentScore / maxScore) * 100;
            let rank = { title: 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°åˆå¿ƒè€…', badgeClass: 'badge-beginner' };

            if (percentage >= 90) {
                rank = { title: 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãƒã‚¹ã‚¿ãƒ¼', badgeClass: 'badge-ultimate' };
            } else if (percentage >= 70) {
                rank = { title: 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ãƒã‚¹ã‚¿ãƒ¼', badgeClass: 'badge-master' };
            } else if (percentage >= 50) {
                rank = { title: 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ä¸Šç´šè€…', badgeClass: 'badge-advanced' };
            } else if (percentage >= 20) {
                rank = { title: 'ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°ä¸­ç´šè€…', badgeClass: 'badge-intermediate' };
            }
            
            rankDisplayEl.innerHTML = `<span class="badge ${rank.badgeClass}">${rank.title}</span>`;
        }
        
        function loadHiScore() {
            const hiScore = localStorage.getItem(`reframingHiScore_${currentUsername}`) || 0;
            hiScoreEl.textContent = hiScore;
            updateRankDisplay(parseInt(hiScore, 10));
            return parseInt(hiScore, 10);
        }

        function init() {
            gamePage.classList.add('hidden');
            topPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
            modalOverlay.style.display = 'none';
            
            if(Tone.Transport.state === 'started') {
                Tone.Transport.stop();
            }
            gameOverSynth.releaseAll();
        }
        
        function showTopPage() {
            loginPage.classList.add('hidden');
            gamePage.classList.add('hidden');
            topPage.classList.remove('hidden');
            
            if(Tone.Transport.state === 'started') {
                Tone.Transport.stop();
            }
            gamePattern.stop();
            topPageLoop.start(0);
            Tone.Transport.start();
            loadHiScore();
        }

        async function startGame() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            
            if(Tone.Transport.state === 'started') {
                Tone.Transport.stop();
            }
            topPageLoop.stop();
            gamePattern.start(0);
            Tone.Transport.start();
            
            score = 0;
            passCount = 3;
            scoreEl.textContent = score;
            passCountEl.textContent = passCount;
            passBtn.disabled = false;
            newRecordTextEl.classList.add('hidden');
            shuffleWords();
            loadHiScore();
            
            modalOverlay.style.display = 'none';
            isPlaying = true;
            isChecking = false;
            answerForm.classList.remove('hidden');
            answerInput.focus();
            
            showNewWord();
        }

        function showNewWord() {
            clearInterval(timerId);
            wordEl.classList.remove('paused-animation'); 
            isChecking = false;
            answerInput.value = '';
            answerInput.disabled = false;
            micBtn.disabled = false;
            passBtn.disabled = passCount <= 0;
            answerInput.focus();

            if (shuffledWords.length === 0) {
                shuffleWords();
            }
            currentWord = shuffledWords.pop();
            wordEl.textContent = currentWord;

            wordEl.style.animation = 'none';
            void wordEl.offsetWidth;
            wordEl.style.animation = `come-closer ${questionTimeLimit}s linear forwards`;
            
            startTimer();
        }

        function startTimer() {
            timeLeft = questionTimeLimit;
            timeEl.textContent = timeLeft;
            timerId = setInterval(() => {
                timeLeft--;
                timeEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    showFeedback(false);
                    setTimeout(gameOver, 1000);
                }
            }, 1000);
        }

        function resumeTimer() {
            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--;
                timeEl.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    showFeedback(false);
                    setTimeout(gameOver, 1000);
                }
            }, 1000);
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if (!isPlaying || isChecking) return;
            const userAnswer = answerInput.value.trim();
            if (userAnswer === '') return;

            clearInterval(timerId);
            isChecking = true;
            answerInput.disabled = true;
            micBtn.disabled = true;
            passBtn.disabled = true;

            const originalButtonContent = micBtn.innerHTML;
            micBtn.innerHTML = '<div id="loading-spinner"></div>';

            try {
                const result = await checkReframing(currentWord, userAnswer);
                if (result.isGoodReframing) {
                    wordEl.classList.add('paused-animation');
                    showFeedback(true);
                    score += 10;
                    scoreEl.textContent = score;
                    setTimeout(showNewWord, 1000);
                } else {
                    showFeedback(false);
                    setTimeout(() => {
                        isChecking = false;
                        answerInput.disabled = false;
                        micBtn.disabled = false;
                        passBtn.disabled = passCount <= 0;
                        answerInput.focus();
                        resumeTimer();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error checking reframing:', error);
                showFeedback(false);
                 setTimeout(() => {
                    isChecking = false;
                    answerInput.disabled = false;
                    micBtn.disabled = false;
                    passBtn.disabled = passCount <= 0;
                    answerInput.focus();
                    resumeTimer();
                }, 1000);
            } finally {
                micBtn.innerHTML = originalButtonContent;
            }
        }
        
        function handlePass() {
            if (!isPlaying || isChecking || passCount <= 0) return;
            passCount--;
            passCountEl.textContent = passCount;
            gameSynth.triggerAttackRelease('A4', '8n');
            clearInterval(timerId);
            showNewWord();
        }

        function showFeedback(isCorrect) {
            feedbackIndicator.textContent = isCorrect ? 'Nice!' : 'Hmm...';
            feedbackIndicator.classList.remove('correct', 'incorrect');
            feedbackIndicator.classList.add(isCorrect ? 'correct' : 'incorrect');
            feedbackIndicator.style.opacity = 1;
            setTimeout(() => {
                feedbackIndicator.style.opacity = 0;
            }, 1000);
        }

        async function checkReframing(originalText, reframedText) {
            const apiKey = "AIzaSyCYAKKl9AzwuAnEMOPX7rDRSsWmTefNyro";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const prompt = `ã‚ãªãŸã¯ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°åˆ¤å®šã®å°‚é–€å®¶ã§ã™ã€‚ãƒã‚¬ãƒ†ã‚£ãƒ–ãªè¨€è‘‰ã€Œ${originalText}ã€ãŒã€ãƒªãƒ•ãƒ¬ãƒ¼ãƒŸãƒ³ã‚°æ¡ˆã€Œ${reframedText}ã€ã«ã‚ˆã£ã¦ã€å…ƒã®çŠ¶æ³ã‚’è¸ã¾ãˆã¤ã¤ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè¦–ç‚¹ã«ã†ã¾ãå¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚å˜ãªã‚‹å¦å®šã‚„ç„¡é–¢ä¿‚ãªç™ºè¨€ã¯ä¸é©åˆ‡ã§ã™ã€‚åˆ¤å®šçµæœã‚’ "good" ã¾ãŸã¯ "bad" ã®ä¸€è¨€ã§ã€JSONå½¢å¼ï¼ˆä¾‹: {"result": "good"}ï¼‰ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
            
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const jsonString = result.candidates[0].content.parts[0].text;
                const parsedResult = JSON.parse(jsonString);
                return { isGoodReframing: parsedResult.result === 'good' };
            } catch (error) {
                console.error("Gemini API Error:", error);
                return { isGoodReframing: false };
            }
        }

        // Firestoreã¸ä¿å­˜ã™ã‚‹é–¢æ•° saveScore(name, score) ãŒ
// ã™ã§ã« index.html ã® <script type="module"> å†…ã«ã‚ã‚‹å‰æã§ã™ã€‚

async function gameOver() {
  isPlaying = false;
  clearInterval(timerId);
  wordEl.classList.add('paused-animation');
  answerForm.classList.add('hidden');

  if (Tone.Transport.state === 'started') {
    Tone.Transport.stop();
  }
  gamePattern.stop();
  gameOverSynth.triggerAttackRelease(['C3', 'E3', 'G3'], '2n');

  modalTitle.textContent = 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼';
  modalText.textContent = `ã‚ãªãŸã®æœ€çµ‚ã‚¹ã‚³ã‚¢ã¯ ${score} ç‚¹ã§ã™ï¼`;

  const hiScoreBefore = loadHiScore();   // ç›´å‰ã®ãƒã‚¤ã‚¹ã‚³ã‚¢
  let bestToSave = hiScoreBefore;

  if (score > hiScoreBefore) {
    // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
    localStorage.setItem(`reframingHiScore_${currentUsername}`, score);
    newRecordTextEl.classList.remove('hidden');
    loadHiScore();

    const now = Tone.now();
    newRecordSynth.triggerAttackRelease(['C5', 'E5', 'G5', 'C6'], '8n', now);
    newRecordSynth.triggerAttackRelease(['E6'], '8n', now + 0.2);

    bestToSave = score; // ä¿å­˜ã™ã‚‹ã®ã¯æ›´æ–°å¾Œã®ãƒã‚¤ã‚¹ã‚³ã‚¢
  } else {
    newRecordTextEl.classList.add('hidden');
  }

  // è¡¨ç¤ºåï¼ˆ16æ–‡å­—ã¾ã§ï¼‰ã€‚currentUsername ãŒç„¡ã‘ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜åâ†’åŒ¿åã®é †ã§ã€‚
  const displayName =
    (typeof currentUsername === 'string' && currentUsername) ||
    localStorage.getItem('rg_username') ||
    'åŒ¿å';

  // Firestoreã«ã€Œåå‰ï¼‹ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ã€ã‚’ä¿å­˜
  if (typeof saveScore === 'function') {
    try {
      await saveScore(displayName.toString().slice(0,16), Number(bestToSave));
    } catch (e) {
      console.error('saveScore failed:', e);
      // å¤±æ•—ã—ã¦ã‚‚ã‚²ãƒ¼ãƒ é€²è¡Œã¯æ­¢ã‚ãªã„
    }
  } else {
    console.warn('saveScore é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Firebaseã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }

  modalOverlay.style.display = 'flex';
}

        
        function toggleMute() {
            isMuted = !isMuted;
            Tone.Destination.mute = isMuted;
            speakerOnIcon.classList.toggle('hidden', isMuted);
            speakerOffIcon.classList.toggle('hidden', !isMuted);
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            currentUsername = usernameInput.value.trim();
            if (currentUsername) {
                localStorage.setItem('reframingCurrentUser', currentUsername);
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
                showTopPage();
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('reframingCurrentUser');
            usernameInput.value = '';
            init();
        });

        startAdventureBtn.addEventListener('click', async () => {
            topPage.classList.add('hidden');
            gamePage.classList.remove('hidden');
            startGame();
        });

        restartBtn.addEventListener('click', () => {
            startGame();
        });
        
        backToTopBtn.addEventListener('click', () => {
            gamePage.classList.add('hidden');
            showTopPage();
        });

        answerForm.addEventListener('submit', handleSubmit);
        micBtn.addEventListener('click', () => {
            if (recognition && !isChecking) {
                micBtn.disabled = true;
                recognition.start();
            }
        });
        passBtn.addEventListener('click', handlePass);
        muteBtn.addEventListener('click', toggleMute);

        // --- Initial Load ---
        window.onload = () => {
            currentUsername = localStorage.getItem('reframingCurrentUser');
            if (currentUsername) {
                usernameInput.value = currentUsername;
                showTopPage();
            } else {
                init();
            }
        };
    </script>
    <section id="ranking" style="max-width:640px;margin:24px auto;color:#fff;">
  <h2 style="margin:0 0 12px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½20ï¼‰</h2>
  <ol id="rankList"></ol>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, serverTimestamp,
    getDocs, collection, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAjMznd4LPaSy3KcjVj5gbZnyllMM8XigU",
  authDomain: "reframing-game.firebaseapp.com",
  projectId: "reframing-game",
  storageBucket: "reframing-game.firebasestorage.app",
  messagingSenderId: "1082764235640",
  appId: "1:1082764235640:web:fef4b92b13a80ecdf5ae8d",
  measurementId: "G-SX62V2ND76"
};
<script type="module">
  // ...ï¼ˆã‚ãªãŸã®FirebaseåˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰/é–¢æ•°ã®ç¶šãï¼‰

  // â–¼ 1å›ã ã‘åå‰ã‚’æ±ºã‚ã¦ localStorage ã«ä¿å­˜
  function getDisplayName() {
    let name = localStorage.getItem("rg_username");
    if (!name) {
      name = prompt("ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«è¡¨ç¤ºã™ã‚‹åå‰ï¼ˆ16æ–‡å­—ã¾ã§ï¼‰");
      if (name) localStorage.setItem("rg_username", name.slice(0,16));
    }
    return localStorage.getItem("rg_username") || "åŒ¿å";
  }

  // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–æ™‚ã«åå‰ã ã‘ç¢ºä¿
  getDisplayName();

  // ï¼ˆä»»æ„ï¼‰ã€Œåå‰ã‚’å¤‰æ›´ã€ã—ãŸã„æ™‚ã«å‘¼ã¶é–¢æ•°
  window.changeDisplayName = () => {
    localStorage.removeItem("rg_username");
    getDisplayName();
  };
</script>


// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const { user } = await signInAnonymously(auth);

  async function saveScore(username, score = 0) {
    const safe = (username || "").toString().slice(0, 16);
    if (!safe) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    await setDoc(doc(db, "scores", user.uid), {
      username: safe,
      score: Number(score),
      createdAt: serverTimestamp()
    }, { merge: true });
    await loadRanking();
  }

  async function loadRanking() {
    const snap = await getDocs(query(collection(db, "scores"), orderBy("score", "desc"), limit(20)));
    const list = document.getElementById("rankList");
    list.innerHTML = "";
    let i = 1;
    snap.docs.forEach(d => {
      const x = d.data();
      const li = document.createElement("li");
      li.textContent = `${i}. ${x.username} â€” ${x.score}`;
      list.appendChild(li);
      i++;
    });
  }

  // æ—¢å­˜ã®UIã¨æ¥ç¶šï¼ˆä»®ID: #playerName ã¨ #startBtnï¼‰
  const nameInput = document.querySelector("#playerName") || document.querySelector("input");
  const startBtn  = document.querySelector("#startBtn")  || document.querySelector("button");
  if (nameInput && startBtn) {
    startBtn.addEventListener("click", () => saveScore(nameInput.value, 0));
  }

  // ã‚²ãƒ¼ãƒ ã§ã‚¹ã‚³ã‚¢ãŒå‡ºãŸã‚‰ï¼š saveScore(playerName, finalScore) ã‚’å‘¼ã¶
  loadRanking();
</script>

<small style="display:block;text-align:center;color:#aab;margin:12px 0;">
  ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯åŒ¿åIDã§è¨˜éŒ²ã—ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚„IPç­‰ã®å€‹äººæƒ…å ±ã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚
</small>
<section id="ranking" style="max-width:640px;margin:24px auto;color:#fff;">
  <h2 style="margin:0 0 12px;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½20ï¼‰</h2>
  <ol id="rankList"></ol>
</section>

<script type="module">
  // --- Firebase SDKã®èª­ã¿è¾¼ã¿ ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, serverTimestamp,
    getDocs, collection, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ã™ã§ã« index.html ã®ä¸Šã®æ–¹ã« firebaseConfig ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹æƒ³å®š
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
  const { user } = await signInAnonymously(auth);

  // ã‚¹ã‚³ã‚¢ä¿å­˜ï¼šusername+scoreã®ã¿
  async function saveScore(username, score = 0) {
    const safe = (username || "").toString().slice(0, 16);
    if (!safe) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    await setDoc(doc(db, "scores", user.uid), {
      username: safe,
      score: Number(score),
      createdAt: serverTimestamp()
    }, { merge: true }); // åŒã˜ç«¯æœ«ãªã‚‰ä¸Šæ›¸ã
    await loadRanking();
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ï¼ˆä¸Šä½20ï¼‰
  async function loadRanking() {
    const snap = await getDocs(
      query(collection(db, "scores"), orderBy("score", "desc"), limit(20))
    );
    const list = document.getElementById("rankList");
    list.innerHTML = "";
    let i = 1;
    snap.docs.forEach(d => {
      const { username, score } = d.data();
      const li = document.createElement("li");
      li.textContent = `${i}. ${username} â€” ${score}`;
      list.appendChild(li);
      i++;
    });
  }

  // æ—¢å­˜UIã¨æ¥ç¶š
  const nameInput = document.getElementById("playerName");
  const startBtn  = document.getElementById("startBtn");
  startBtn?.addEventListener("click", () => saveScore(nameInput?.value || "", 0));

  // åˆæœŸè¡¨ç¤º
  loadRanking();
  // åå‰å¤‰æ›´ãƒªãƒ³ã‚¯ã®å‹•ä½œ
document.getElementById('change-name-link').addEventListener('click', function (e) {
    e.preventDefault();
    const newName = prompt('æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ16æ–‡å­—ä»¥å†…ï¼‰');
    if (newName && newName.trim() !== '') {
        const trimmed = newName.trim().slice(0, 16);
        localStorage.setItem('rg_username', trimmed);
        alert(`åå‰ã‚’ã€Œ${trimmed}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸï¼`);
        location.reload(); // å†èª­ã¿è¾¼ã¿ã§åæ˜ 
    }
});

</script>

<small style="display:block;text-align:center;color:#aab;margin:12px 0;">
  ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯åŒ¿åIDã§è¨˜éŒ²ã—ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã‚„IPç­‰ã®å€‹äººæƒ…å ±ã¯ä¿å­˜ã—ã¾ã›ã‚“ã€‚
</small>

</body>
</html>
